<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador RISC-V OoO (Tomasulo) - Trilha A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos personalizados para tabelas densas */
       .register-cell { font-family: 'Courier New', monospace; font-size: 0.85rem; }
       .highlight-change { animation: flash 1s; background-color: #4ade80; }
        @keyframes flash { 0% { background-color: #4ade80; } 100% { background-color: transparent; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans p-4">
    <div class="container mx-auto max-w-7xl">
        <header class="mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-blue-400">Simulador RISC-V Superescalar (Tomasulo + ROB)</h1>
            <p class="text-gray-400">Trilha A: 2-Issue, Out-of-Order, Branch Prediction, L1I/L1D Caches</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-600">Código Assembly (RV32I)</h2>
                <textarea id="code-input" class="w-full h-40 bg-gray-900 text-green-400 font-mono p-2 rounded border border-gray-700 focus:border-blue-500 focus:outline-none text-sm" spellcheck="false">
addi x1, x0, 10
addi x2, x0, 20
add x3, x1, x2  ; Dependência RAW (x1, x2)
sub x4, x3, x1  ; Dependência RAW (x3, x1)
beq x1, x2, 2   ; Desvio NÃO tomado
beq x1, x1, 2   ; Desvio TOMADO (causa flush)
nop             ; (Será "flushed")
addi x5, x0, 5
lw x6, 4(x0)
add x7, x6, x1  ; Stall por Load
jal x0, 2       ; Salto incondicional
nop
addi x8, x0, 8
</textarea>
                <div class="mt-3 flex gap-2">
                    <button id="btn-load" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-bold transition">Carregar Programa</button>
                    <button id="btn-step" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-bold transition disabled:opacity-50" disabled>Step (Ciclo)</button>
                    <button id="btn-run" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-sm font-bold transition disabled:opacity-50" disabled>Run (Executar)</button>
                    <button id="btn-reset" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-bold transition">Reset</button>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-3 border-b border-gray-600">Configuração de Cache</h2>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <label class="block text-gray-400 mb-1">Latência L1I (ciclos)</label>
                        <input type="number" id="conf-l1i-lat" value="1" class="w-full bg-gray-700 p-1 rounded border border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1">Latência L1D (ciclos)</label>
                        <input type="number" id="conf-l1d-lat" value="2" class="w-full bg-gray-700 p-1 rounded border border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1">Penalidade Miss (ciclos)</label>
                        <input type="number" id="conf-miss-pen" value="10" class="w-full bg-gray-700 p-1 rounded border border-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-400 mb-1">Janela ROB</label>
                        <input type="number" id="conf-rob-size" value="32" class="w-full bg-gray-700 p-1 rounded border border-gray-600">
                    </div>
                </div>
                
                <h2 class="text-xl font-semibold mt-4 mb-2 border-b border-gray-600">Métricas Globais</h2>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="flex justify-between"><span>Ciclos:</span> <span id="metric-cycles" class="font-mono text-yellow-400">0</span></div>
                    <div class="flex justify-between"><span>PC:</span> <span id="metric-pc" class="font-mono text-cyan-400">0x0</span></div>
                    <div class="flex justify-between"><span>IPC:</span> <span id="metric-ipc" class="font-mono">0.00</span></div>
                    <div class="flex justify-between"><span>Inst. Commit:</span> <span id="metric-insts" class="font-mono">0</span></div>
                    
                    <div class="flex justify-between"><span>Acc. Desvio:</span> <span id="metric-branch-acc" class="font-mono text-cyan-400">0.00%</span></div>
                    <div class="flex justify-between"><span>Média Ocup. ROB:</span> <span id="metric-avg-rob" class="font-mono">0.00</span></div>
                    <div class="flex justify-between"><span>Máx Ocup. ROB:</span> <span id="metric-max-rob" class="font-mono">0</span></div>
                    <div class="flex justify-between"><span>Média Ocup. RS:</span> <span id="metric-avg-rs" class="font-mono">0.00</span></div>
                    <div class="flex justify-between"><span>Máx Ocup. RS:</span> <span id="metric-max-rs" class="font-mono">0</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg overflow-hidden">
                <h3 class="text-lg font-semibold mb-2 text-purple-400">Reorder Buffer (ROB) - Commit In-Order</h3>
                <div class="overflow-y-auto h-64 border border-gray-700 rounded">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-700 text-gray-300 sticky top-0">
                            <tr>
                                <th class="p-2">ID</th>
                                <th class="p-2">Instrução</th>
                                <th class="p-2">Estado</th>
                                <th class="p-2">Dest</th>
                                <th class="p-2">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="rob-table-body" class="font-mono divide-y divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg shadow-lg overflow-hidden">
                <h3 class="text-lg font-semibold mb-2 text-orange-400">Reservation Stations (RS) - Execução OoO</h3>
                <div class="overflow-y-auto h-64 border border-gray-700 rounded">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-700 text-gray-300 sticky top-0">
                            <tr>
                                <th class="p-2">Nome</th>
                                <th class="p-2">Busy</th>
                                <th class="p-2">Op</th>
                                <th class="p-2">Vj</th>
                                <th class="p-2">Vk</th>
                                <th class="p-2">Qj</th>
                                <th class="p-2">Qk</th>
                                <th class="p-2">ROB#</th>
                            </tr>
                        </thead>
                        <tbody id="rs-table-body" class="font-mono divide-y divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg overflow-hidden">
                <h3 class="text-lg font-semibold mb-2 text-red-400">Load/Store Queue (LSQ)</h3>
                <div class="overflow-y-auto h-64 border border-gray-700 rounded">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-700 text-gray-300 sticky top-0">
                            <tr>
                                <th class="p-2">ROB#</th>
                                <th class="p-2">Tipo</th>
                                <th class="p-2">Endereço</th>
                                <th class="p-2">Mem. Ready</th>
                            </tr>
                        </thead>
                        <tbody id="lsq-table-body" class="font-mono divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg h-96 overflow-hidden">
                <h3 class="text-lg font-semibold mb-2 text-green-400">Registradores (ARF + RAT)</h3>
                <div class="overflow-y-auto h-full border border-gray-700 rounded">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-700 text-gray-300 sticky top-0">
                            <tr>
                                <th class="p-2">Reg</th>
                                <th class="p-2">Valor (Hex)</th>
                                <th class="p-2">Valor (Dec)</th>
                                <th class="p-2">RAT (ROB#)</th>
                            </tr>
                        </thead>
                        <tbody id="reg-table-body" class="font-mono divide-y divide-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col h-96">
                <h3 class="text-lg font-semibold mb-2 text-yellow-400">Estatísticas de Memória & Log de Eventos</h3>
                <div class="grid grid-cols-2 gap-4 mb-4 text-xs">
                    <div class="bg-gray-700 p-2 rounded">
                        <h4 class="font-bold text-center border-b border-gray-600 mb-1">L1 Instruction Cache</h4>
                        <div class="flex justify-between"><span>Accesses:</span> <span id="l1i-access">0</span></div>
                        <div class="flex justify-between"><span>Hits:</span> <span id="l1i-hits" class="text-green-400">0</span></div>
                        <div class="flex justify-between"><span>Misses:</span> <span id="l1i-misses" class="text-red-400">0</span></div>
                        <div class="flex justify-between"><span>Miss Rate:</span> <span id="l1i-rate">0%</span></div>
                    </div>
                    <div class="bg-gray-700 p-2 rounded">
                        <h4 class="font-bold text-center border-b border-gray-600 mb-1">L1 Data Cache</h4>
                        <div class="flex justify-between"><span>Accesses:</span> <span id="l1d-access">0</span></div>
                        <div class="flex justify-between"><span>Hits:</span> <span id="l1d-hits" class="text-green-400">0</span></div>
                        <div class="flex justify-between"><span>Misses:</span> <span id="l1d-misses" class="text-red-400">0</span></div>
                        <div class="flex justify-between"><span>Miss Rate:</span> <span id="l1d-rate">0%</span></div>
                    </div>
                </div>
                <div id="sim-log" class="flex-1 bg-black p-2 font-mono text-xs text-green-500 overflow-y-auto border border-gray-700 rounded whitespace-pre-wrap">
                    > Simulador pronto. Carregue um programa.
                </div>
            </div>
        </div>
    </div>

    <script src="simulator.js"></script>
</body>
</html>